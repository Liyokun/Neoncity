<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Neon City – Lite</title>
<style>
body { margin:0; overflow:hidden; background:#000; touch-action:none; }
#joystick-zone {
    position:absolute; bottom:40px; left:40px;
    width:120px; height:120px; opacity:.8;
}
</style>
</head>
<body>
<div id="joystick-zone"></div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

<script type="module">
import * as THREE from 'three';

/* === BASIC SETUP === */
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
    75, window.innerWidth/window.innerHeight, 0.1, 800
);
camera.position.set(0, 1.6, 5); // KHÓA ĐỘ CAO → không lơ lửng

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* === LIGHT (CỰC NHẸ) === */
scene.add(new THREE.AmbientLight(0x8888aa, 1));

/* === CUBEMAP === */
const cubeLoader = new THREE.CubeTextureLoader();
cubeLoader.load(
    ['px.png','nx.png','py.png','ny.png','pz.png','nz.png'],
    tex => scene.background = tex
);

/* === FAKE GROUND (DÁN SÁT CUBEMAP) === */
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshBasicMaterial({
        color:0x000000,
        transparent:true,
        opacity:0.15
    })
);
ground.rotation.x = -Math.PI/2;
ground.position.y = 0.01; // sát chân
scene.add(ground);

/* === CONTROLS === */
let move = { f:0, r:0 };
let look = { lon:-90, lat:0 };
let drag=false, sx, sy, slon, slat;

const joy = nipplejs.create({
    zone: document.getElementById('joystick-zone'),
    mode:'static',
    position:{ left:'60px', bottom:'60px' }
});
joy.on('move',(e,d)=>{ move.f=d.vector.y; move.r=d.vector.x; });
joy.on('end',()=> move={f:0,r:0});

document.addEventListener('pointerdown',e=>{
    drag=true;
    sx=e.clientX; sy=e.clientY;
    slon=look.lon; slat=look.lat;
});
document.addEventListener('pointermove',e=>{
    if(!drag) return;
    look.lon = (sx - e.clientX)*0.15 + slon;
    look.lat = (e.clientY - sy)*0.15 + slat;
});
document.addEventListener('pointerup',()=> drag=false);

/* === LOOP === */
const clock = new THREE.Clock();
function animate(){
    requestAnimationFrame(animate);
    const dt = clock.getDelta();

    look.lat = Math.max(-80, Math.min(80, look.lat));
    const phi = THREE.MathUtils.degToRad(90 - look.lat);
    const theta = THREE.MathUtils.degToRad(look.lon);
    const target = new THREE.Vector3()
        .setFromSphericalCoords(1,phi,theta)
        .add(camera.position);
    camera.lookAt(target);

    if(move.f||move.r){
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir);
        dir.y=0; dir.normalize();
        const side = new THREE.Vector3().crossVectors(camera.up,dir);
        camera.position.addScaledVector(dir, move.f*6*dt);
        camera.position.addScaledVector(side,-move.r*6*dt);
    }

    renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>