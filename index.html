<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ðŸŒƒ Cyberpunk - Grounded Reality</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: monospace; }
        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; z-index: 100; opacity: 0.8; }
        #loading { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; display: flex; align-items: center; justify-content: center;
            z-index: 999; transition: opacity 1s; color: #00f2ff; flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="loading"><h1>âš¡ LOADING 6-FACE WORLD...</h1></div>
    <div id="joystick-zone"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <script type="module">
        import * as THREE from 'three';
        // Import cÃ´ng cá»¥ GroundedSkybox giÃºp "háº¡ cÃ¡nh" áº£nh ná»n xuá»‘ng máº·t Ä‘áº¥t
        import { GroundedSkybox } from 'https://unpkg.com/three@0.160.0/examples/jsm/objects/GroundedSkybox.js';

        // === 1. SETUP ===
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a1f);
        
        // SÆ°Æ¡ng mÃ¹ nháº¹ Ä‘á»ƒ lÃ m má»m Ä‘Æ°á»ng chÃ¢n trá»i
        scene.fog = new THREE.Fog(0x0a0a1f, 20, 100); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; 
        document.body.appendChild(renderer.domElement);

        // === 2. LOAD Bá»˜ 6 áº¢NH (CUBEMAP) ===
        const loader = new THREE.CubeTextureLoader();
        // Náº¡p Ä‘Ãºng thá»© tá»±: Pháº£i, TrÃ¡i, TrÃªn, DÆ°á»›i, TrÆ°á»›c, Sau
        // HÃ£y Ä‘áº£m báº£o báº¡n Ä‘Ã£ upload cÃ¡c file nÃ y lÃªn GitHub
        const texture = loader.load([
            './px.jpg', './nx.jpg',
            './py.jpg', './ny.jpg',
            './pz.jpg', './nz.jpg'
        ], () => {
            // Khi táº£i xong 6 áº£nh
            console.log("ÄÃ£ táº£i xong 6 máº·t tháº¿ giá»›i!");
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => document.getElementById('loading').style.display = 'none', 1000);
        }, undefined, (err) => {
            console.error(err);
            document.querySelector('#loading h1').innerText = "ERROR: CHECK FILE NAMES";
            document.querySelector('#loading h1').style.color = "red";
        });

        // === 3. Táº O GROUNDED SKYBOX (THáº¾ GIá»šI CHáº M Äáº¤T) ===
        // GroundedSkybox(texture, height, radius)
        // height: Ä‘á»™ cao báº§u trá»i (cÃ ng cao cÃ ng thoÃ¡ng)
        // radius: bÃ¡n kÃ­nh vÃ¹ng Ä‘áº¥t pháº³ng (cÃ ng lá»›n thÃ¬ Ä‘i cÃ ng xa khÃ´ng bá»‹ mÃ©o)
        const skybox = new GroundedSkybox(texture, 15, 70); 
        skybox.position.y = 0; // Äáº·t chuáº©n ngay chÃ¢n
        scene.add(skybox);

        // === 4. Máº¶T SÃ€N Váº¬T LÃ (TRONG SUá»T) ===
        // SÃ n nÃ y Ä‘á»ƒ há»©ng bÃ³ng Ä‘á»• vÃ  va cháº¡m, nhÆ°ng máº¯t sáº½ nhÃ¬n xuyÃªn qua nÃ³ Ä‘á»ƒ tháº¥y áº£nh ná»n
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 100),
            new THREE.MeshStandardMaterial({ 
                color: 0x000000, 
                transparent: true, 
                opacity: 0.1, // HÆ¡i má» Ä‘á»ƒ báº¯t bÃ³ng Ä‘á»• cá»§a Ä‘Ã¨n
                roughness: 0.1,
                metalness: 0.5
            })
        );
        ground.rotation.x = -Math.PI / 2; 
        ground.receiveShadow = true;
        scene.add(ground);

        // VÅ©ng nÆ°á»›c pháº£n chiáº¿u (cÅ©ng chá»‰nh trong suá»‘t Ä‘á»ƒ hÃ²a trá»™n)
        const puddles = [
            { x: 3, z: 2, r: 2 }, { x: -4, z: -3, r: 1.5 },
            { x: 5, z: -5, r: 1.8 }, { x: -6, z: 4, r: 2.2 }
        ];
        puddles.forEach(p => {
            const puddle = new THREE.Mesh(
                new THREE.CircleGeometry(p.r, 32),
                new THREE.MeshStandardMaterial({ 
                    color: 0x001133, 
                    roughness: 0.0, 
                    metalness: 1.0,
                    transparent: true,
                    opacity: 0.6 
                })
            );
            puddle.rotation.x = -Math.PI / 2;
            puddle.position.set(p.x, 0.01, p.z);
            scene.add(puddle);
        });

        // === 5. ÃNH SÃNG & ÄÃˆN ===
        scene.add(new THREE.AmbientLight(0x404040, 0.5));

        const lampPos = [[-8, -8], [8, -8], [-8, 8], [8, 8]];
        lampPos.forEach((p, i) => {
            const color = i%2==0 ? 0xff006e : 0x00f2ff;
            const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 5), new THREE.MeshStandardMaterial({color: 0x111111}));
            pole.position.set(p[0], 2.5, p[1]);
            scene.add(pole);
            
            const light = new THREE.PointLight(color, 150, 20);
            light.position.set(p[0], 4.8, p[1]);
            light.castShadow = true;
            scene.add(light);
            
            const bulb = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color: color}));
            bulb.position.copy(light.position);
            scene.add(bulb);
        });

        // === 6. MÆ¯A ===
        const rainGeo = new THREE.BufferGeometry();
        const rainCount = 4000;
        const rainPos = new Float32Array(rainCount * 3);
        for(let i=0; i<rainCount*3; i++) rainPos[i] = (Math.random() - 0.5) * 60;
        rainGeo.setAttribute('position', new THREE.BufferAttribute(rainPos, 3));
        const rainSystem = new THREE.Points(rainGeo, new THREE.PointsMaterial({color: 0xaaaaaa, size: 0.1, transparent: true, opacity: 0.6}));
        scene.add(rainSystem);

        // === 7. ÄIá»€U KHIá»‚N ===
        let move = { f: 0, r: 0 }, look = { x: 0, y: 0 };
        let interact = false, start = { x: 0, y: 0, lx: 0, ly: 0 };

        const joy = nipplejs.create({ zone: document.getElementById('joystick-zone'), mode: 'static', position: {left: '60px', bottom: '60px'}, color: 'cyan' });
        joy.on('move', (e, d) => { move.f = d.vector.y; move.r = d.vector.x; });
        joy.on('end', () => { move.f = 0; move.r = 0; });

        document.addEventListener('pointerdown', e => { 
            if(e.clientX > window.innerWidth/2) { interact = true; start = {x: e.clientX, y: e.clientY, lx: look.x, ly: look.y}; }
        });
        document.addEventListener('pointermove', e => {
            if(interact) {
                look.x = start.lx + (start.x - e.clientX) * 0.2;
                look.y = start.ly + (e.clientY - start.y) * 0.2;
            }
        });
        document.addEventListener('pointerup', () => interact = false);

        const keys = {};
        window.onkeydown = e => keys[e.key.toLowerCase()] = true;
        window.onkeyup = e => keys[e.key.toLowerCase()] = false;

        // Giá»›i háº¡n vÃ¹ng di chuyá»ƒn trong bÃ¡n kÃ­nh 15m Ä‘á»ƒ khÃ´ng Ä‘i ra khá»i vÃ¹ng áº£nh Ä‘áº¹p
        function checkCol(pos) { return (Math.abs(pos.x) > 15 || Math.abs(pos.z) > 15); }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // MÆ°a rÆ¡i
            const pos = rainSystem.geometry.attributes.position.array;
            for(let i=1; i<pos.length; i+=3) {
                pos[i] -= 0.5;
                if(pos[i] < 0) pos[i] = 40;
            }
            rainSystem.geometry.attributes.position.needsUpdate = true;

            // Camera
            look.y = Math.max(-85, Math.min(85, look.y));
            const phi = THREE.MathUtils.degToRad(90 - look.y);
            const theta = THREE.MathUtils.degToRad(look.x);
            const target = new THREE.Vector3().setFromSphericalCoords(1, phi, theta).add(camera.position);
            camera.lookAt(target);

            // Move
            if(move.f || move.r) {
                const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
                const side = new THREE.Vector3().crossVectors(camera.up, dir).normalize();
                const next = camera.position.clone().addScaledVector(dir, move.f * 5 * dt).addScaledVector(side, -move.r * 5 * dt);
                if(!checkCol(next)) camera.position.copy(next);
            }
            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
